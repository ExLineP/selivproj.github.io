function tcalc__init(recId,idField){var rec=document.querySelector("#rec"+recId);if(rec){var wrapper=rec.querySelector('[data-input-lid="'+idField+'"]');if(wrapper){var calcResult=wrapper.querySelector(".t-calc");calcResult||(calcResult=rec.querySelector(".t-calc"));var strExpr=calcResult.getAttribute("data-calc-expr"),elementsChange=rec.querySelectorAll(".t-select, .t-radio, .t-checkbox, .t-img-select"),elementsClick=rec.querySelectorAll(".t-inputquantity__btn"),elementsMultEventsInput=rec.querySelectorAll(".t-input"),elementsMultEventsRange=rec.querySelectorAll(".t-range");if(strExpr){var objExpr=tcalc__getParseExpression(strExpr=strExpr.replace(/\s/g,"").replace(/,/g,"."));tcalc__cashOperandsFieldsEls(rec,objExpr),tcalc__cutAndHideFieldsValues(objExpr),!0!==objExpr.error?(Array.prototype.forEach.call(elementsMultEventsInput,(function(element){Array.prototype.forEach.call(["keyup","keydown","input"],(function(event){element.addEventListener(event,(function(){setTimeout((function(){tcalc__changeVal(rec,wrapper,calcResult,tcalc__calcValue(objExpr))}),1)}))}))})),Array.prototype.forEach.call(elementsChange,(function(element){element.addEventListener("change",(function(){tcalc__changeVal(rec,wrapper,calcResult,tcalc__calcValue(objExpr))}))})),Array.prototype.forEach.call(elementsClick,(function(element){element.addEventListener("click",(function(){tcalc__changeVal(rec,wrapper,calcResult,tcalc__calcValue(objExpr))}))})),Array.prototype.forEach.call(elementsMultEventsRange,(function(element){Array.prototype.forEach.call(["click","input","change"],(function(event){element.addEventListener(event,(function(){tcalc__changeVal(rec,wrapper,calcResult,tcalc__calcValue(objExpr))}))}))})),tcalc__changeVal(rec,wrapper,calcResult,tcalc__calcValue(objExpr))):console.log("Please check math expression or input names(especially spaces) in rec"+recId)}else console.log("Error: formula field is empty in rec"+recId)}}}function tcalc__getParseExpression(strExpr){var chars=strExpr.split(""),arrOperands=[],arrOperators=[],index=0,isOperatorsLast=!0;arrOperands[index]=Object.create(null),arrOperands[index].str="";for(var i=0;i<chars.length;i++)"("!==chars[i]&&")"!==chars[i]&&("+"!==chars[i]&&"-"!==chars[i]&&"*"!==chars[i]&&"/"!==chars[i]||isOperatorsLast?(arrOperands[index].str+=chars[i],isOperatorsLast=!1):(arrOperators[index]=chars[i],arrOperands[++index]=Object.create(null),arrOperands[index].str="",isOperatorsLast=!0));return{str:strExpr,operands:arrOperands,operators:arrOperators}}function tcalc__cashOperandsFieldsEls(rec,objExpr){for(var i=0;i<objExpr.operands.length;i++){var str=objExpr.operands[i].str;if(isNaN(str)){var fields=rec.querySelectorAll('[name="'+str+'"]');if(!fields)return console.log("Error: incorrect operand: "+str),void(objExpr.error=!0);objExpr.operands[i].type="variable",objExpr.operands[i].field=fields}else objExpr.operands[i].type="number",objExpr.operands[i].value=+objExpr.operands[i].str}}function tcalc__cutAndHideFieldsValues(objExpr){for(var i=0;i<objExpr.operands.length;i++){var operand=objExpr.operands[i];if("variable"===operand.type){var fields=operand.field,field=fields[0];if(field.classList.contains("t-select")){var options=field.querySelectorAll("option");Array.prototype.forEach.call(options,(function(option){var val=option.value;if(val){var values=val.split("=");values.length<2||(option.value=values[0],option.innerHTML=values[0],option.setAttribute("data-calc-value",values[1]))}}))}if(field.classList.contains("t-checkboxes__hiddeninput")||field.classList.contains("t-checkbox")||field.classList.contains("t-radio")){if(field.classList.contains("t-checkboxes__hiddeninput"))var block,elements=(block=field.closest(".t-input-block")).querySelectorAll(".t-checkbox");else var elements=fields;Array.prototype.forEach.call(elements,(function(element){var parent=element.classList.contains("t-radio")?element.closest(".t-radio__control"):element.closest(".t-checkbox__control"),labelText=parent.querySelector(".t-checkbox__labeltext"),val=parent.textContent;if(labelText&&(val=labelText.textContent),val){var values=val.split("=");if(!(values.length<2))if(element.closest(".t-input-group_rd")&&element.setAttribute("value",values[0]),element.setAttribute("data-calc-value",values[1]),labelText)labelText.textContent=values[0];else{var els=parent.childNodes;els[els.length-1].textContent=values[0]}}}))}if(field.classList.contains("t-img-select__hiddeninput")||field.classList.contains("t-img-select")){if(field.classList.contains("t-img-select__hiddeninput"))var block,elements=(block=field.closest(".t-input-block")).querySelectorAll(".t-img-select");else var elements=fields;Array.prototype.forEach.call(elements,(function(element){var parent=element.closest(".t-img-select__control"),text=parent.querySelector(".t-img-select__text"),val=text.textContent;if(val){var values=val.split("=");values.length<2||(values[0]?element.setAttribute("value",values[0]):element.setAttribute("value",parent.querySelector(".t-img-select__indicator").getAttribute("data-original")),element.setAttribute("data-calc-value",values[1]),text.textContent=values[0])}}))}}}}function tcalc__changeVal(rec,wrapper,calcResult,res){var hiddenInputResult=wrapper.querySelector(".t-calc__hiddeninput");if(hiddenInputResult||(hiddenInputResult=rec.querySelector(".t-calc__hiddeninput")),isNaN(res)?(calcResult.innerHTML=0,hiddenInputResult.value=0):(calcResult.innerHTML=res,hiddenInputResult.value=res),wrapper.querySelector('input[type="hidden"][class^="t-calc__hidden__prod"]')){var formParent=wrapper.closest(".t-form__inputsbox"),inputImg=wrapper.querySelector(".t-calc__hidden__prod_img"),inputTitle=wrapper.querySelector(".t-calc__hidden__prod_title"),inputImgValue="",inputTitleValue="";inputImg&&(inputImgValue=inputImg.value||""),inputTitle&&(inputTitleValue=inputTitle.value||"NoName");var objExpr={str:inputTitleValue,variables:[]},variables=objExpr.str.match(/[A-z0-9_]+/gi);for(var i in variables){var fieldRadio=formParent.querySelectorAll('[type="radio"][name="'+variables[i]+'"]:checked');if(1===fieldRadio.length)objExpr.variables.push({str:variables[i],value:fieldRadio[0].value});else{var field=formParent.querySelectorAll('[name="'+variables[i]+'"]');1===field.length&&objExpr.variables.push({str:variables[i],value:field[0].value})}}for(var j in objExpr.variables){var str=objExpr.variables[j].str,value=objExpr.variables[j].value;str&&value&&(inputTitleValue=inputTitleValue.replace(new RegExp(str),value))}var submit=formParent.querySelector('[class$="-form__submit"] button.t-submit'),order="#order:"+inputTitleValue+"="+res;inputImgValue&&(order+=":::image="+inputImgValue),submit.setAttribute("href",order),submit.setAttribute("type","")}}function tcalc__calcValue(objExpr){tcalc__getFieldsValues(objExpr);for(var evalStr=objExpr.str,i=0;i<objExpr.operands.length;i++){var valToInsert=objExpr.operands[i].value;valToInsert=valToInsert<0?"(0"+valToInsert+")":valToInsert,evalStr=evalStr.replace(objExpr.operands[i].str,valToInsert)}try{var result=tcalc__evaluate(tcalc__parse(evalStr))}catch(err){console.log("Something went wrong in form calculator! Please, connect support or developers")}return Math.round(10*result)/10}function tcalc__getFieldsValues(objExpr){for(var i=0;i<objExpr.operands.length;i++)if("variable"==objExpr.operands[i].type){var fields=objExpr.operands[i].field,field=fields[0],isRadioImg=field.classList.contains("t-img-select")&&"radio"===field.getAttribute("type"),isCheckboxImg=field.classList.contains("t-img-select__hiddeninput");if(field.classList.contains("t-input")||field.classList.contains("t-range")||field.classList.contains("t-calc__hiddeninput")){var value=field.value;tcalc__getFieldsValues__saveToArr(objExpr.operands[i],value)}if(field.classList.contains("t-select")){var option=field.querySelector("option:checked"),value=0;option&&(value=option.getAttribute("data-calc-value")),tcalc__getFieldsValues__saveToArr(objExpr.operands[i],value)}if(field.classList.contains("t-radio")||field.classList.contains("t-checkbox")||isRadioImg){var checkedInput=Array.prototype.filter.call(fields,(function(field){if(field.checked)return field})),value=0;checkedInput[0]&&(value=checkedInput[0].getAttribute("data-calc-value")),tcalc__getFieldsValues__saveToArr(objExpr.operands[i],value)}if(field.classList.contains("t-checkboxes__hiddeninput")||isCheckboxImg){var parent=field.closest(".t-input-block"),checkedInputs=isCheckboxImg?parent.querySelectorAll(".t-img-select:checked"):parent.querySelectorAll(".t-checkbox:checked"),valSum=0;Array.prototype.forEach.call(checkedInputs,(function(input){var value=input.getAttribute("data-calc-value");value=value?value.replace(/[^0-9.]/g,""):0,valSum+=parseFloat(value)})),tcalc__getFieldsValues__saveToArr(objExpr.operands[i],valSum.toString())}}}function tcalc__getFieldsValues__saveToArr(operand,value){var isNegative=parseInt(value,10)<0;value=value?value.replace(/,/g,".").replace(/[^0-9.]/g,""):"",operand.value=value?parseFloat(value):0,isNegative&&(operand.value=-operand.value)}function tcalc__evaluate(obj){switch(obj.type){case"number":return parseFloat(obj.value);case"+":return tcalc__evaluate(obj.left)+tcalc__evaluate(obj.right);case"-":return tcalc__evaluate(obj.left)-tcalc__evaluate(obj.right);case"*":return tcalc__evaluate(obj.left)*tcalc__evaluate(obj.right);case"/":return tcalc__evaluate(obj.left)/tcalc__evaluate(obj.right)}}function tcalc__parse(formula){var opts={tokens:tcalc__tokenize(formula),position:0},result=tcalc__parseExpr(opts);if(opts.position!==opts.tokens.length)throw new SyntaxError("unexpected '"+tcalc__peek(opts)+"'");return result}function tcalc__tokenize(formula){for(var results=[],tokenRegExp=/\s*([A-Za-z]+|[0-9.]+|\S)\s*/g,m;m=tokenRegExp.exec(formula);)results.push(m[1]);return results}function tcalc__parseExpr(opts){for(var expr=tcalc__parseMulExpr(opts),t=tcalc__peek(opts);"+"===t||"-"===t;){var rhs;tcalc__consume(opts),expr={type:t,left:expr,right:tcalc__parseMulExpr(opts)},t=tcalc__peek(opts)}return expr}function tcalc__parseMulExpr(opts){for(var expr=tcalc__parsePrimaryExpr(opts),t=tcalc__peek(opts);"*"===t||"/"===t;){var rhs;tcalc__consume(opts),expr={type:t,left:expr,right:tcalc__parsePrimaryExpr(opts)},t=tcalc__peek(opts)}return expr}function tcalc__parsePrimaryExpr(opts){var t=tcalc__peek(opts);if(tcalc__isNumber(t))return tcalc__consume(opts),{type:"number",value:t};if(tcalc__isName(t))return tcalc__consume(opts),{type:"name",id:t};if("("===t){tcalc__consume(opts);var expr=tcalc__parseExpr(opts);if(")"!==tcalc__peek(opts))throw new SyntaxError("expected )");return tcalc__consume(opts),expr}throw new SyntaxError("expected a number, a variable, or parentheses")}function tcalc__peek(opts){return opts.tokens[opts.position]}function tcalc__consume(opts){opts.position++}function tcalc__isName(token){return token&&token.match(/^[A-Za-z]+$/)}function tcalc__isNumber(token){return token&&token.match(/^[0-9.]+$/)}Array.prototype.some||(Array.prototype.some=function(fun){"use strict";if(null==this)throw new TypeError("Array.prototype.some called on null or undefined");if("function"!=typeof fun)throw new TypeError;for(var t=Object(this),len=t.length>>>0,thisArg=arguments.length>=2?arguments[1]:void 0,i=0;i<len;i++)if(i in t&&fun.call(thisArg,t[i],i,t))return!0;return!1}),function(e){var matches=e.matches||e.matchesSelector||e.webkitMatchesSelector||e.mozMatchesSelector||e.msMatchesSelector||e.oMatchesSelector;e.matches=e.matchesSelector=matches||function matches(selector){var matches=document.querySelectorAll(selector),th=this;return Array.prototype.some.call(matches,(function(e){return e===th}))}}(Element.prototype),Element.prototype.closest||(Element.prototype.closest=function(s){for(var el=this;el&&1===el.nodeType;){if(Element.prototype.matches.call(el,s))return el;el=el.parentElement||el.parentNode}return null});